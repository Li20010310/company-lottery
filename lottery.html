<!-- 在 lottery.html 的 JavaScript 部分添加： -->
<script>
    // 从本地存储读取签到数据
    function getSigninData() {
        try {
            const eventData = localStorage.getItem('company_event_2025');
            if (eventData) {
                const data = JSON.parse(eventData);
                console.log('读取到签到数据，总人数:', data.participants.length);
                
                // 过滤出有抽奖资格且未中奖的人员
                const eligibleParticipants = data.participants.filter(
                    p => p.hasLotteryChance && !p.isWinner
                );
                
                return {
                    allParticipants: data.participants,
                    eligibleParticipants: eligibleParticipants,
                    total: data.participants.length,
                    eligible: eligibleParticipants.length
                };
            }
        } catch (error) {
            console.error('读取签到数据失败:', error);
        }
        
        return {
            allParticipants: [],
            eligibleParticipants: [],
            total: 0,
            eligible: 0
        };
    }
    
    // 更新抽奖池显示
    function updateLotteryPool() {
        const data = getSigninData();
        document.getElementById('signedCount').textContent = data.total;
        document.getElementById('poolCount').textContent = data.eligible;
        document.getElementById('wonCount').textContent = data.total - data.eligible;
        
        return data.eligibleParticipants;
    }
    
    // 抽奖函数
    function drawWinner() {
        const eligibleParticipants = updateLotteryPool();
        
        if (eligibleParticipants.length === 0) {
            alert('所有签到者均已获奖或无人可抽！');
            return;
        }
        
        // 随机选择中奖者
        const randomIndex = Math.floor(Math.random() * eligibleParticipants.length);
        const winner = eligibleParticipants[randomIndex];
        
        // 更新中奖状态
        markAsWinner(winner.id);
        
        // 显示中奖者
        displayWinner(winner);
    }
    
    // 标记为中奖者
    function markAsWinner(userId) {
        try {
            const eventData = JSON.parse(localStorage.getItem('company_event_2025'));
            const user = eventData.participants.find(p => p.id === userId);
            
            if (user) {
                user.isWinner = true;
                user.winTime = new Date().toISOString();
                // 可以设置奖品等级
                user.prize = determinePrizeLevel();
                
                localStorage.setItem('company_event_2025', JSON.stringify(eventData));
                console.log('已标记为中奖者:', user.name);
            }
        } catch (error) {
            console.error('标记中奖者失败:', error);
        }
    }
</script>
