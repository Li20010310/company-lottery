<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæœå±•ç­¾åˆ° - å‚ä¸æŠ½å¥–</title>
    <style>
        /* ä¿æŒåŸæœ‰çš„æ ·å¼ï¼Œæ·»åŠ æ–°æ ·å¼ */
        .auto-checkin-panel {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            display: none;
        }
        
        .manual-checkin-panel {
            display: block;
        }
        
        .user-name {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .checkin-success {
            font-size: 1.8rem;
            margin: 20px 0;
        }
    </style>
    <script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- è‡ªåŠ¨ç­¾åˆ°é¢æ¿ï¼ˆæ‰«ç åæ˜¾ç¤ºï¼‰ -->
        <div id="autoCheckinPanel" class="auto-checkin-panel">
            <h1>ğŸ‰ ç­¾åˆ°æˆåŠŸï¼ ğŸ‰</h1>
            <div class="user-name" id="autoUserName"></div>
            <p class="checkin-success">æ‚¨å·²æˆåŠŸè¿›å…¥æŠ½å¥–æ± </p>
            <p>è¯·å…³é—­æ­¤é¡µé¢ï¼Œç­‰å¾…æŠ½å¥–å¼€å§‹</p>
            <div style="margin-top: 30px;">
                <button onclick="shareCheckin()" style="background: white; color: #43e97b;">
                    ğŸ“± åˆ†äº«ç­¾åˆ°é“¾æ¥
                </button>
            </div>
        </div>
        
        <!-- æ‰‹åŠ¨ç­¾åˆ°é¢æ¿ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
        <div id="manualCheckinPanel" class="manual-checkin-panel">
            <h1>æˆæœå±•æŠ½å¥–ç­¾åˆ°</h1>
            <p>è¯·è®©å·¥ä½œäººå‘˜æ‰«ææ‚¨çš„ä¸“å±ç­¾åˆ°ç </p>
            
            <div class="qrcode-container">
                <div id="userQrcode"></div>
            </div>
            
            <p style="margin: 15px 0; color: #555;">æˆ–æ‰‹åŠ¨è¾“å…¥å§“åï¼š</p>
            
            <div class="input-group">
                <input type="text" id="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
            </div>
            
            <button onclick="generateUserQRCode()">
                ğŸ« ç”Ÿæˆæˆ‘çš„ç­¾åˆ°ç 
            </button>
            
            <div class="tip">
                <p>ğŸ“Œ è¯·å·¥ä½œäººå‘˜æ‰«æä¸Šæ–¹äºŒç»´ç å®Œæˆç­¾åˆ°</p>
                <p>âœ¨ æˆ–è¾“å…¥å§“åç”Ÿæˆä¸ªäººç­¾åˆ°ç </p>
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜ç­¾åˆ°é¢æ¿ï¼ˆå·¥ä½œäººå‘˜ç”¨ï¼‰ -->
        <div id="adminPanel" style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px dashed #ddd;">
            <h3>ğŸ‘¨â€ğŸ’¼ å·¥ä½œäººå‘˜ç­¾åˆ°åŒº</h3>
            <p>æ‰«æå‚ä¼šäººå‘˜çš„äºŒç»´ç å®Œæˆç­¾åˆ°</p>
            <input type="text" id="scanInput" placeholder="æ‰«ææˆ–è¾“å…¥ç­¾åˆ°ç " style="width: 100%;">
            <button onclick="processCheckin()" style="background: #4a6fa5; margin-top: 10px;">
                âœ… ç¡®è®¤ç­¾åˆ°
            </button>
            <div id="scanResult"></div>
        </div>
    </div>
    
    <script>
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥URLå‚æ•°
        window.onload = function() {
            // è§£æURLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const checkinType = urlParams.get('type');
            const userName = urlParams.get('name');
            const userId = urlParams.get('id');
            
            console.log('URLå‚æ•°:', { checkinType, userName, userId });
            
            // æƒ…å†µ1ï¼šå‘˜å·¥æ‰«ç ç­¾åˆ°ï¼ˆtype=checkinï¼‰
            if (checkinType === 'checkin' && userName) {
                autoCheckin(userName, userId);
                return;
            }
            
            // æƒ…å†µ2ï¼šå·¥ä½œäººå‘˜ç•Œé¢ï¼ˆtype=adminï¼‰
            if (checkinType === 'admin') {
                showAdminPanel();
                return;
            }
            
            // æƒ…å†µ3ï¼šæ™®é€šè®¿é—®ï¼Œæ˜¾ç¤ºé»˜è®¤ç•Œé¢
            initializeDefault();
            
            // ç›‘å¬æ‰«æè¾“å…¥æ¡†
            document.getElementById('scanInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processCheckin();
                }
            });
        };
        
        // è‡ªåŠ¨ç­¾åˆ°å¤„ç†
        function autoCheckin(userName, userId) {
            // éšè—æ‰‹åŠ¨ç­¾åˆ°é¢æ¿
            document.getElementById('manualCheckinPanel').style.display = 'none';
            
            // æ˜¾ç¤ºè‡ªåŠ¨ç­¾åˆ°æˆåŠŸé¢æ¿
            document.getElementById('autoCheckinPanel').style.display = 'block';
            
            // æ˜¾ç¤ºç”¨æˆ·å
            document.getElementById('autoUserName').textContent = userName;
            
            // è®°å½•ç­¾åˆ°
            recordCheckin(userName, userId || Date.now().toString());
            
            // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            playSuccessSound();
            
            // 5ç§’åæç¤ºå…³é—­é¡µé¢
            setTimeout(() => {
                const msg = document.createElement('p');
                msg.textContent = 'â° é¡µé¢å°†åœ¨10ç§’åè‡ªåŠ¨å…³é—­...';
                msg.style.fontSize = '14px';
                msg.style.color = '#666';
                document.getElementById('autoCheckinPanel').appendChild(msg);
                
                setTimeout(() => {
                    // ä¸è‡ªåŠ¨å…³é—­ï¼Œåªæ˜¯æç¤º
                    msg.textContent = 'âœ… ç­¾åˆ°å·²å®Œæˆï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨å…³é—­æ­¤é¡µé¢';
                }, 10000);
            }, 3000);
        }
        
        // ç”Ÿæˆä¸ªäººç­¾åˆ°ç 
        function generateUserQRCode() {
            const userName = document.getElementById('userName').value.trim();
            
            if (!userName) {
                alert('è¯·è¾“å…¥å§“å');
                return;
            }
            
            // ç”Ÿæˆç”¨æˆ·ID
            const userId = 'user_' + Date.now();
            
            // ç”Ÿæˆç­¾åˆ°é“¾æ¥
            const checkinUrl = generateCheckinUrl(userName, userId);
            
            // æ¸…ç©ºåŸæœ‰äºŒç»´ç 
            document.getElementById('userQrcode').innerHTML = '';
            
            // ç”Ÿæˆæ–°äºŒç»´ç 
            new QRCode(document.getElementById('userQrcode'), {
                text: checkinUrl,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff"
            });
            
            // æ˜¾ç¤ºæç¤º
            document.querySelector('.tip').innerHTML = `
                <p>âœ… æ‚¨çš„ä¸ªäººç­¾åˆ°ç å·²ç”Ÿæˆ</p>
                <p>ğŸ“± è¯·å‡ºç¤ºæ­¤ç ç»™å·¥ä½œäººå‘˜æ‰«æ</p>
                <p style="font-size: 12px; color: #888;">æˆ–åˆ†äº«é“¾æ¥ï¼š<br><small>${checkinUrl}</small></p>
            `;
            
            // ä¿å­˜åˆ°æœ¬åœ°ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
            localStorage.setItem('userCheckinUrl', checkinUrl);
            localStorage.setItem('userName', userName);
        }
        
        // ç”Ÿæˆç­¾åˆ°URL
        function generateCheckinUrl(userName, userId) {
            // è·å–å½“å‰é¡µé¢åŸºç¡€URL
            const baseUrl = window.location.origin + window.location.pathname;
            
            // æ„å»ºç­¾åˆ°å‚æ•°
            const params = new URLSearchParams({
                type: 'checkin',
                name: encodeURIComponent(userName),
                id: userId,
                t: Date.now() // æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
            });
            
            return `${baseUrl}?${params.toString()}`;
        }
        
        // è®°å½•ç­¾åˆ°
        function recordCheckin(userName, userId) {
            try {
                // è·å–ç°æœ‰æ•°æ®
                let checkinRecords = JSON.parse(localStorage.getItem('checkinRecords') || '[]');
                let lotteryPool = JSON.parse(localStorage.getItem('lotteryPool') || '[]');
                
                // æ£€æŸ¥æ˜¯å¦å·²ç­¾åˆ°
                const alreadyChecked = checkinRecords.some(record => 
                    record.name === userName || record.id === userId
                );
                
                if (alreadyChecked) {
                    console.log('ç”¨æˆ·å·²ç­¾åˆ°:', userName);
                    return;
                }
                
                // æ·»åŠ æ–°è®°å½•
                const record = {
                    id: userId,
                    name: userName,
                    time: new Date().toISOString(),
                    timestamp: Date.now(),
                    ip: 'æ‰«ç ç­¾åˆ°' // å®é™…ä¸­å¯è®°å½•æ›´å¤šä¿¡æ¯
                };
                
                checkinRecords.push(record);
                
                // æ·»åŠ åˆ°æŠ½å¥–æ± 
                if (!lotteryPool.some(user => user.id === userId)) {
                    lotteryPool.push({
                        id: userId,
                        name: userName,
                        isWon: false,
                        checkinTime: new Date().toLocaleString()
                    });
                }
                
                // ä¿å­˜æ•°æ®
                localStorage.setItem('checkinRecords', JSON.stringify(checkinRecords));
                localStorage.setItem('lotteryPool', JSON.stringify(lotteryPool));
                
                console.log('ç­¾åˆ°è®°å½•ä¿å­˜æˆåŠŸ:', record);
                console.log('å½“å‰æŠ½å¥–æ± :', lotteryPool);
                
                // å‘é€åˆ°æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
                // sendToServer(record);
                
            } catch (error) {
                console.error('è®°å½•ç­¾åˆ°å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿
        function showAdminPanel() {
            document.getElementById('manualCheckinPanel').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('scanInput').focus();
        }
        
        // å¤„ç†æ‰«æç­¾åˆ°
        function processCheckin() {
            const scanInput = document.getElementById('scanInput');
            const inputValue = scanInput.value.trim();
            
            if (!inputValue) {
                alert('è¯·è¾“å…¥æˆ–æ‰«æç­¾åˆ°ç ');
                return;
            }
            
            // è§£æè¾“å…¥ï¼ˆå¯èƒ½æ˜¯URLæˆ–çº¯æ–‡æœ¬ï¼‰
            let userName = '';
            let userId = '';
            
            // å°è¯•è§£æURL
            try {
                const url = new URL(inputValue);
                const params = new URLSearchParams(url.search);
                userName = params.get('name') || '';
                userId = params.get('id') || '';
                
                // è§£ç URLç¼–ç 
                if (userName) {
                    userName = decodeURIComponent(userName);
                }
            } catch {
                // å¦‚æœä¸æ˜¯URLï¼Œç›´æ¥å½“ä½œå§“åå¤„ç†
                userName = inputValue;
                userId = 'manual_' + Date.now();
            }
            
            if (!userName) {
                document.getElementById('scanResult').innerHTML = 
                    '<p style="color:red;">âŒ æ— æ³•è¯†åˆ«çš„ç­¾åˆ°ç </p>';
                return;
            }
            
            // æ‰§è¡Œç­¾åˆ°
            recordCheckin(userName, userId);
            
            // æ˜¾ç¤ºç»“æœ
            document.getElementById('scanResult').innerHTML = `
                <p style="color:green;">âœ… ${userName} ç­¾åˆ°æˆåŠŸï¼</p>
                <p style="font-size:14px;">æ—¶é—´ï¼š${new Date().toLocaleTimeString()}</p>
            `;
            
            // æ¸…ç©ºè¾“å…¥æ¡†å¹¶èšç„¦
            scanInput.value = '';
            scanInput.focus();
            
            // æ’­æ”¾æç¤ºéŸ³
            playSuccessSound();
        }
        
        // åˆ†äº«ç­¾åˆ°é“¾æ¥
        function shareCheckin() {
            const savedUrl = localStorage.getItem('userCheckinUrl');
            const userName = localStorage.getItem('userName');
            
            if (savedUrl && userName) {
                if (navigator.share) {
                    // ä½¿ç”¨Web Share API
                    navigator.share({
                        title: 'æˆ‘çš„ç­¾åˆ°é“¾æ¥ - ' + userName,
                        text: 'è¿™æ˜¯æˆ‘çš„æ´»åŠ¨ç­¾åˆ°é“¾æ¥',
                        url: savedUrl
                    });
                } else {
                    // å¤åˆ¶åˆ°å‰ªè´´æ¿
                    navigator.clipboard.writeText(savedUrl)
                        .then(() => alert('ç­¾åˆ°é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
                        .catch(() => prompt('è¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥ï¼š', savedUrl));
                }
            } else {
                alert('è¯·å…ˆç”Ÿæˆæ‚¨çš„ç­¾åˆ°ç ');
            }
        }
        
        // åˆå§‹åŒ–é»˜è®¤ç•Œé¢
        function initializeDefault() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯
            const savedName = localStorage.getItem('userName');
            if (savedName) {
                document.getElementById('userName').value = savedName;
                generateUserQRCode();
            }
        }
        
        // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
        function playSuccessSound() {
            // ç®€å•çš„éŸ³é¢‘åé¦ˆ
            const audio = new Audio();
            audio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ';
            audio.play().catch(() => { /* å¿½ç•¥é”™è¯¯ */ });
        }
    </script>
</body>
</html>
