<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæœå±•ç»Ÿä¸€ç­¾åˆ°å…¥å£</title>
    <style>
        /* æ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ï¼Œçœç•¥ä»¥èŠ‚çœç©ºé—´ */
        /* ä½¿ç”¨æ‚¨åŸæ¥çš„æ ·å¼å³å¯ */
    </style>
    
    <!-- ä¸åœ¨è¿™é‡Œå¼•å…¥ä»»ä½•CDNï¼Œæˆ‘ä»¬åŠ¨æ€åŠ è½½ -->
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å†…å®¹ä¿æŒä¸å˜ -->
        <!-- ä½¿ç”¨æ‚¨åŸæ¥çš„HTMLç»“æ„ -->
        
        <div class="qrcode-container">
            <div class="qrcode-label">ç»Ÿä¸€ç­¾åˆ°äºŒç»´ç </div>
            <div id="qrcode">
                <!-- æ˜¾ç¤ºåŠ è½½çŠ¶æ€ -->
                <div id="qrcodeLoading" style="padding: 40px; text-align: center;">
                    <div style="margin-bottom: 15px;">ğŸ”„ æ­£åœ¨åŠ è½½äºŒç»´ç åº“...</div>
                    <div class="spinner"></div>
                    <style>
                        .spinner {
                            border: 4px solid #f3f3f3;
                            border-top: 4px solid #1a2980;
                            border-radius: 50%;
                            width: 40px;
                            height: 40px;
                            animation: spin 1s linear infinite;
                            margin: 0 auto;
                        }
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                </div>
            </div>
        </div>
        
        <!-- å…¶ä»–å†…å®¹ä¿æŒä¸å˜ -->
    </div>
    
    <script>
        // ==================== äºŒç»´ç ç”Ÿæˆæ ¸å¿ƒä»£ç  ====================
        
        // å¤šä¸ªCDNæºï¼Œç¡®ä¿è‡³å°‘ä¸€ä¸ªå¯ç”¨
        const QRCODE_SOURCES = [
            'https://cdn.staticfile.org/qrcodejs/1.0.0/qrcode.min.js',  // æœ€ç¨³å®šçš„å›½å†…CDN
            'https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',
            'https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js', // å­—èŠ‚è·³åŠ¨CDN
            'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js',
            './qrcode.min.js'  // æœ¬åœ°æ–‡ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        ];
        
        // åŠ¨æ€åŠ è½½äºŒç»´ç åº“
        function loadQRCodeLibrary() {
            console.log('å¼€å§‹åŠ è½½äºŒç»´ç åº“...');
            
            let loaded = false;
            
            function tryLoad(index) {
                if (index >= QRCODE_SOURCES.length) {
                    if (!loaded) {
                        console.error('æ‰€æœ‰CDNéƒ½åŠ è½½å¤±è´¥');
                        usePureJSQRCode();
                        showFallbackMessage();
                    }
                    return;
                }
                
                const source = QRCODE_SOURCES[index];
                console.log(`å°è¯•åŠ è½½: ${source}`);
                
                const script = document.createElement('script');
                script.src = source;
                
                script.onload = function() {
                    if (!loaded) {
                        loaded = true;
                        console.log(`âœ… æˆåŠŸåŠ è½½: ${source}`);
                        
                        // ç§»é™¤åŠ è½½åŠ¨ç”»
                        const loadingEl = document.getElementById('qrcodeLoading');
                        if (loadingEl) loadingEl.remove();
                        
                        // ç”ŸæˆäºŒç»´ç 
                        setTimeout(generateQRCode, 100);
                    }
                };
                
                script.onerror = function() {
                    console.warn(`âŒ åŠ è½½å¤±è´¥: ${source}`);
                    
                    // ç§»é™¤å¤±è´¥çš„scriptæ ‡ç­¾
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    
                    // å°è¯•ä¸‹ä¸€ä¸ªæº
                    setTimeout(() => tryLoad(index + 1), 300);
                };
                
                document.head.appendChild(script);
                
                // è®¾ç½®è¶…æ—¶ï¼ˆ5ç§’ï¼‰
                setTimeout(() => {
                    if (!loaded && script.parentNode) {
                        script.parentNode.removeChild(script);
                        tryLoad(index + 1);
                    }
                }, 5000);
            }
            
            // ä»ç¬¬ä¸€ä¸ªæºå¼€å§‹å°è¯•
            tryLoad(0);
        }
        
        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode() {
            try {
                // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½æˆåŠŸ
                if (typeof QRCode === 'undefined') {
                    throw new Error('QRCodeåº“æœªå®šä¹‰');
                }
                
                const qrcodeElement = document.getElementById('qrcode');
                if (!qrcodeElement) return;
                
                // æ¸…ç©ºå®¹å™¨
                qrcodeElement.innerHTML = '';
                
                // è·å–å½“å‰é¡µé¢URL
                const currentUrl = window.location.href;
                console.log('ç”ŸæˆäºŒç»´ç ï¼ŒURL:', currentUrl);
                
                // åˆ›å»ºäºŒç»´ç 
                new QRCode(qrcodeElement, {
                    text: currentUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#1a2980",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.Q
                });
                
                console.log('âœ… äºŒç»´ç ç”ŸæˆæˆåŠŸ');
                
                // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆå¯é€‰ï¼‰
                setTimeout(() => {
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        position: absolute;
                        top: -25px;
                        left: 0;
                        right: 0;
                        text-align: center;
                        color: #1a2980;
                        font-size: 12px;
                        font-weight: bold;
                    `;
                    successMsg.textContent = 'âœ… å·²ç”Ÿæˆï¼Œè¯·æ‰«ç ';
                    qrcodeElement.parentNode.style.position = 'relative';
                    qrcodeElement.parentNode.appendChild(successMsg);
                    
                    // 3ç§’åæ·¡å‡º
                    setTimeout(() => {
                        successMsg.style.transition = 'opacity 1s';
                        successMsg.style.opacity = '0';
                        setTimeout(() => {
                            if (successMsg.parentNode) {
                                successMsg.parentNode.removeChild(successMsg);
                            }
                        }, 1000);
                    }, 3000);
                }, 500);
                
            } catch (error) {
                console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
                usePureJSQRCode();
            }
        }
        
        // çº¯JSç”Ÿæˆç®€å•äºŒç»´ç ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function usePureJSQRCode() {
            console.log('ä½¿ç”¨çº¯JSç”ŸæˆäºŒç»´ç ');
            
            const qrcodeElement = document.getElementById('qrcode');
            if (!qrcodeElement) return;
            
            // ç§»é™¤åŠ è½½åŠ¨ç”»
            const loadingEl = document.getElementById('qrcodeLoading');
            if (loadingEl) loadingEl.remove();
            
            const currentUrl = window.location.href;
            
            // åˆ›å»ºcanvas
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            canvas.style.border = '1px solid #ddd';
            const ctx = canvas.getContext('2d');
            
            // ç»˜åˆ¶ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 200, 200);
            
            // ç»˜åˆ¶è¾¹æ¡†
            ctx.strokeStyle = '#1a2980';
            ctx.lineWidth = 3;
            ctx.strokeRect(5, 5, 190, 190);
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = '#1a2980';
            ctx.font = 'bold 16px "Microsoft YaHei"';
            ctx.textAlign = 'center';
            ctx.fillText('å…¬å¸ç­¾åˆ°ç³»ç»Ÿ', 100, 50);
            
            // ç»˜åˆ¶æç¤º
            ctx.fillStyle = '#666';
            ctx.font = '14px "Microsoft YaHei"';
            ctx.fillText('è¯·æ‰«ææ­¤äºŒç»´ç ', 100, 80);
            ctx.fillText('æˆ–æ‰‹åŠ¨è¾“å…¥ç½‘å€', 100, 100);
            
            // æ˜¾ç¤ºç¼©çŸ­çš„URL
            ctx.font = '12px "Microsoft YaHei"';
            ctx.fillStyle = '#26d0ce';
            
            let displayUrl = currentUrl;
            if (displayUrl.length > 30) {
                // æå–åŸŸåéƒ¨åˆ†
                try {
                    const urlObj = new URL(displayUrl);
                    displayUrl = urlObj.hostname + urlObj.pathname.substring(0, 15) + '...';
                } catch (e) {
                    displayUrl = displayUrl.substring(0, 27) + '...';
                }
            }
            
            ctx.fillText(displayUrl, 100, 130);
            
            // ç»˜åˆ¶æ‰‹æœºå›¾æ ‡
            ctx.font = 'bold 24px Arial';
            ctx.fillText('ğŸ“±', 100, 170);
            
            // æ·»åŠ åˆ°é¡µé¢
            qrcodeElement.innerHTML = '';
            qrcodeElement.appendChild(canvas);
            
            // æ·»åŠ æç¤º
            const tip = document.createElement('div');
            tip.style.cssText = `
                margin-top: 10px;
                color: #666;
                font-size: 12px;
                text-align: center;
            `;
            tip.textContent = 'ï¼ˆå¤‡ç”¨äºŒç»´ç ï¼‰';
            qrcodeElement.appendChild(tip);
        }
        
        // æ˜¾ç¤ºå¤‡ç”¨ä¿¡æ¯
        function showFallbackMessage() {
            const fallbackDiv = document.createElement('div');
            fallbackDiv.style.cssText = `
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 8px;
                padding: 15px;
                margin: 20px 0;
                text-align: center;
            `;
            
            fallbackDiv.innerHTML = `
                <h3 style="color: #856404; margin-top: 0;">äºŒç»´ç ç”Ÿæˆå¤±è´¥</h3>
                <p>è¯·ç›´æ¥è®¿é—®ï¼š</p>
                <p style="background: #f8f9fa; padding: 10px; border-radius: 5px; word-break: break-all;">
                    <strong>${window.location.href}</strong>
                </p>
                <p style="font-size: 14px; color: #666; margin-top: 10px;">
                    æˆ–å°†æ­¤ç½‘å€å¤åˆ¶åˆ°æµè§ˆå™¨åœ°å€æ 
                </p>
            `;
            
            const container = document.querySelector('.container');
            if (container) {
                const qrcodeContainer = document.querySelector('.qrcode-container');
                if (qrcodeContainer) {
                    container.insertBefore(fallbackDiv, qrcodeContainer.nextSibling);
                }
            }
        }
        
        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–ç­¾åˆ°ç³»ç»Ÿ...');
            
            // 1. æ˜¾ç¤ºå½“å‰é¡µé¢URL
            const urlElement = document.getElementById('pageUrl');
            if (urlElement) {
                urlElement.textContent = window.location.href;
            }
            
            // 2. åŠ è½½äºŒç»´ç åº“ï¼ˆå…³é”®ï¼ï¼‰
            setTimeout(loadQRCodeLibrary, 500);
            
            // 3. ç»‘å®šäº‹ä»¶
            const nameInput = document.getElementById('name');
            if (nameInput) {
                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') signIn();
                });
            }
            
            // 4. æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStatistics();
            
            // 5. ä¿å­˜URLä¾›æŠ½å¥–é¡µé¢ä½¿ç”¨
            saveCheckinUrlForLottery();
        };
        
        // ==================== ç­¾åˆ°åŠŸèƒ½ï¼ˆä¿æŒä¸å˜ï¼‰ ====================
        // ... æ‚¨çš„ç­¾åˆ°åŠŸèƒ½ä»£ç  ...
        
        function signIn() {
            // åŸæœ‰çš„ç­¾åˆ°é€»è¾‘ä¿æŒä¸å˜
            console.log('ç­¾åˆ°åŠŸèƒ½');
            // ...
        }
        
        function updateStatistics() {
            // åŸæœ‰çš„ç»Ÿè®¡é€»è¾‘
            console.log('æ›´æ–°ç»Ÿè®¡');
            // ...
        }
        
        function saveCheckinUrlForLottery() {
            try {
                localStorage.setItem('event_checkin_url', window.location.href);
            } catch (e) {
                console.warn('æ— æ³•ä¿å­˜URL');
            }
        }
        
        // ==================== äºŒç»´ç æµ‹è¯•å‡½æ•° ====================
        function testQRCode() {
            console.log('=== QRCodeåº“æµ‹è¯• ===');
            console.log('QRCodeç±»å‹:', typeof QRCode);
            
            if (typeof QRCode !== 'undefined') {
                console.log('âœ… QRCodeåº“å¯ç”¨');
                
                // å¿«é€Ÿæµ‹è¯•ç”Ÿæˆ
                const testDiv = document.createElement('div');
                testDiv.style.display = 'none';
                document.body.appendChild(testDiv);
                
                try {
                    new QRCode(testDiv, {
                        text: 'https://test.example.com',
                        width: 50,
                        height: 50
                    });
                    console.log('âœ… äºŒç»´ç ç”Ÿæˆæµ‹è¯•é€šè¿‡');
                    document.body.removeChild(testDiv);
                    return true;
                } catch (error) {
                    console.error('âŒ äºŒç»´ç ç”Ÿæˆæµ‹è¯•å¤±è´¥:', error);
                    return false;
                }
            } else {
                console.log('âŒ QRCodeåº“ä¸å¯ç”¨');
                return false;
            }
        }
        
        // åœ¨æ§åˆ¶å°æš´éœ²æµ‹è¯•å‡½æ•°
        console.log('è°ƒè¯•å‘½ä»¤: testQRCode() - æµ‹è¯•äºŒç»´ç åŠŸèƒ½');
    </script>
</body>
</html>
