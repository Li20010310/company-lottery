<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæœå±•ç­¾åˆ° - å‚ä¸æŠ½å¥–</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            padding: 40px;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1rem;
        }
        
        .qrcode-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px dashed #ddd;
            margin: 25px auto;
            display: inline-block;
        }
        
        #qrcode {
            width: 220px;
            height: 220px;
            margin: 0 auto;
        }
        
        .input-group {
            margin: 25px 0;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #2575fc;
        }
        
        button {
            background: linear-gradient(45deg, #FF416C, #FF4B2B);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block !important;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block !important;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block !important;
        }
        
        .tip {
            font-size: 14px;
            color: #666;
            margin-top: 25px;
            line-height: 1.5;
        }
        
        .fallback {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .fallback code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            word-break: break-all;
            font-family: monospace;
        }
    </style>
    
    <!-- æ–¹æ¡ˆ1ï¼šä½¿ç”¨å›½å†…BootCDNï¼ˆæœ€ç¨³å®šï¼‰ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- æ–¹æ¡ˆ2ï¼šå¤‡ç”¨CDNï¼ˆå¦‚æœä¸Šé¢å¤±è´¥ï¼‰ -->
    <script>
        // æ£€æµ‹QRCodeåº“æ˜¯å¦åŠ è½½æˆåŠŸ
        function checkQRCodeLoaded() {
            if (typeof QRCode === 'undefined') {
                console.warn('BootCDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
                loadBackupQRCode();
            }
        }
        
        // åŠ è½½å¤‡ç”¨CDN
        function loadBackupQRCode() {
            const script = document.createElement('script');
            script.src = 'https://cdn.staticfile.org/qrcodejs/1.0.0/qrcode.min.js';
            script.onload = function() {
                console.log('å¤‡ç”¨CDNåŠ è½½æˆåŠŸ');
                initializeQRCode();
            };
            script.onerror = function() {
                console.error('æ‰€æœ‰CDNéƒ½å¤±è´¥äº†ï¼Œä½¿ç”¨çº¯JSç”Ÿæˆ');
                usePureJSQRCode();
            };
            document.head.appendChild(script);
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>ğŸ‰ æˆæœå±•æŠ½å¥–ç­¾åˆ° ğŸ‰</h1>
        <p class="subtitle">è¯·æ‰«ç ç­¾åˆ°ï¼Œå³å¯å‚ä¸å¹¸è¿æŠ½å¥–</p>
        
        <div class="qrcode-container">
            <div id="qrcode"></div>
        </div>
        
        <p style="margin: 15px 0; color: #555;">æˆ–ç›´æ¥è¾“å…¥å§“åï¼š</p>
        
        <div class="input-group">
            <input type="text" id="name" placeholder="è¯·è¾“å…¥æ‚¨çš„çœŸå®å§“å" autocomplete="off">
        </div>
        
        <button id="signinBtn" onclick="signIn()">
            âœ… ç¡®è®¤ç­¾åˆ°
        </button>
        
        <div id="message"></div>
        
        <div class="fallback" id="fallback" style="display: none;">
            <p>ğŸ“± <strong>å¤‡ç”¨è®¿é—®æ–¹å¼ï¼š</strong></p>
            <p>å¦‚æœäºŒç»´ç æ— æ³•æ‰«æï¼Œè¯·ç›´æ¥è®¿é—®ï¼š</p>
            <p><code id="pageUrl"></code></p>
            <p style="margin-top: 10px;">æˆ–è¾“å…¥ä¸Šæ–¹ç½‘å€åˆ°æµè§ˆå™¨</p>
        </div>
        
        <div class="tip">
            <p>âœ¨ ç­¾åˆ°æˆåŠŸå³è¿›å…¥æŠ½å¥–æ± </p>
            <p>ğŸ“Œ æ¯äººä»…æœ‰ä¸€æ¬¡ä¸­å¥–æœºä¼š</p>
            <p>â° æŠ½å¥–ç»“æœå°†åœ¨æ´»åŠ¨ç»“æŸåå…¬å¸ƒ</p>
        </div>
    </div>
    
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // æ£€æŸ¥QRCodeåº“æ˜¯å¦åŠ è½½
            setTimeout(checkQRCodeLoaded, 1000);
            
            // æ˜¾ç¤ºå½“å‰é¡µé¢URLï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
            document.getElementById('pageUrl').textContent = window.location.href;
            
            // åˆå§‹åŒ–äºŒç»´ç ï¼ˆå»¶è¿Ÿä¸€ç‚¹ç¡®ä¿åº“åŠ è½½å®Œæˆï¼‰
            setTimeout(initializeQRCode, 1500);
            
            // ç›‘å¬å›è½¦é”®
            document.getElementById('name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    signIn();
                }
            });
        };
        
        // åˆå§‹åŒ–äºŒç»´ç 
        function initializeQRCode() {
            const qrcodeElement = document.getElementById('qrcode');
            
            if (typeof QRCode === 'undefined') {
                console.error('QRCodeåº“æœªåŠ è½½');
                showFallback();
                return;
            }
            
            try {
                // æ¸…ç©ºå®¹å™¨
                qrcodeElement.innerHTML = '';
                
                // è·å–å½“å‰é¡µé¢URL
                const currentUrl = window.location.href;
                console.log('ç”ŸæˆäºŒç»´ç ï¼ŒURL:', currentUrl);
                
                // åˆ›å»ºäºŒç»´ç å®ä¾‹
                const qrcode = new QRCode(qrcodeElement, {
                    text: currentUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                console.log('äºŒç»´ç ç”ŸæˆæˆåŠŸ');
                showMessage('äºŒç»´ç å·²ç”Ÿæˆï¼Œè¯·ä½¿ç”¨æ‰‹æœºæ‰«ç ', 'info');
                
            } catch (error) {
                console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
                showFallback();
            }
        }
        
        // ä½¿ç”¨çº¯JSç”Ÿæˆç®€å•äºŒç»´ç ï¼ˆå¤‡ç”¨çš„å¤‡ç”¨ï¼‰
        function usePureJSQRCode() {
            const qrcodeElement = document.getElementById('qrcode');
            const url = window.location.href;
            
            // åˆ›å»ºcanvas
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');
            
            // ç»˜åˆ¶ç®€å•äºŒç»´ç æ ·å¼
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 200, 200);
            
            // ç»˜åˆ¶è¾¹æ¡†
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 4;
            ctx.strokeRect(10, 10, 180, 180);
            
            // ç»˜åˆ¶æ–‡å­—
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('è¯·æ‰«æäºŒç»´ç ', 100, 90);
            
            ctx.font = '12px Arial';
            ctx.fillText('æˆ–è®¿é—®:', 100, 120);
            
            ctx.font = '10px Arial';
            // æ˜¾ç¤ºç¼©çŸ­çš„URL
            let displayUrl = url;
            if (displayUrl.length > 30) {
                displayUrl = displayUrl.substring(0, 27) + '...';
            }
            ctx.fillText(displayUrl, 100, 140);
            
            ctx.font = 'bold 24px Arial';
            ctx.fillText('ğŸ“±', 100, 180);
            
            // æ·»åŠ åˆ°é¡µé¢
            qrcodeElement.innerHTML = '';
            qrcodeElement.appendChild(canvas);
            
            console.log('çº¯JSäºŒç»´ç ç”Ÿæˆå®Œæˆ');
            showFallback();
        }
        
        // æ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
        function showFallback() {
            document.getElementById('fallback').style.display = 'block';
            showMessage('å»ºè®®ç›´æ¥è¾“å…¥ä¸Šæ–¹ç½‘å€è®¿é—®', 'info');
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = type;
        }
        
        // ç­¾åˆ°åŠŸèƒ½
        function signIn() {
            const nameInput = document.getElementById('name');
            const name = nameInput.value.trim();
            
            if (!name) {
                showMessage('è¯·è¾“å…¥æ‚¨çš„å§“å', 'error');
                nameInput.focus();
                return;
            }
            
            if (name.length < 2 || name.length > 20) {
                showMessage('å§“åé•¿åº¦åº”åœ¨2-20ä¸ªå­—ä¹‹é—´', 'error');
                return;
            }
            
            // æ˜¾ç¤ºå¤„ç†ä¸­
            const signinBtn = document.getElementById('signinBtn');
            const originalText = signinBtn.textContent;
            signinBtn.textContent = 'å¤„ç†ä¸­...';
            signinBtn.disabled = true;
            
            // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
            setTimeout(function() {
                try {
                    // 1. è·å–ç°æœ‰çš„ç­¾åˆ°æ•°æ®
                    let signedUsers = JSON.parse(localStorage.getItem('signedUsers') || '[]');
                    let lotteryPool = JSON.parse(localStorage.getItem('lotteryPool') || '[]');
                    
                    // 2. æ£€æŸ¥æ˜¯å¦å·²ç­¾åˆ°
                    if (signedUsers.includes(name)) {
                        showMessage(`æ‚¨å·²ç»ç­¾åˆ°è¿‡äº†ï¼Œ${name}ï¼`, 'info');
                        signinBtn.textContent = originalText;
                        signinBtn.disabled = false;
                        return;
                    }
                    
                    // 3. æ·»åŠ æ–°ç”¨æˆ·
                    signedUsers.push(name);
                    localStorage.setItem('signedUsers', JSON.stringify(signedUsers));
                    
                    // 4. æ·»åŠ åˆ°æŠ½å¥–æ± 
                    const user = {
                        name: name,
                        id: Date.now(),
                        isWon: false,
                        signTime: new Date().toLocaleString('zh-CN'),
                        ip: 'è®°å½•IPåœ°å€' // å®é™…ä¸­å¯ä»¥è®°å½•IPé˜²ä½œå¼Š
                    };
                    
                    lotteryPool.push(user);
                    localStorage.setItem('lotteryPool', JSON.stringify(lotteryPool));
                    
                    // 5. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage(`âœ… ${name}ï¼Œç­¾åˆ°æˆåŠŸï¼ç¥æ‚¨å¥½è¿ï¼`, 'success');
                    
                    // 6. æ¸…ç©ºè¾“å…¥æ¡†
                    nameInput.value = '';
                    
                    // 7. æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆå¯é€‰ï¼‰
                    playSuccessSound();
                    
                    // 8. è®°å½•æ—¥å¿—
                    console.log('ç­¾åˆ°æˆåŠŸ:', user);
                    console.log('å½“å‰æŠ½å¥–æ± :', lotteryPool);
                    
                } catch (error) {
                    console.error('ç­¾åˆ°å‡ºé”™:', error);
                    showMessage('ç­¾åˆ°å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®
                    setTimeout(function() {
                        signinBtn.textContent = originalText;
                        signinBtn.disabled = false;
                    }, 1500);
                }
            }, 800); // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        }
        
        // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
        function playSuccessSound() {
            try {
                // ä½¿ç”¨ç®€å•çš„éŸ³é¢‘æç¤º
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
            } catch (e) {
                // éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œé™é»˜å¤„ç†
                console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥ï¼ˆå¿½ç•¥ï¼‰');
            }
        }
        
        // æ£€æµ‹æœ¬åœ°å­˜å‚¨æ˜¯å¦å¯ç”¨
        function checkLocalStorage() {
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                return true;
            } catch (e) {
                showMessage('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæœ¬åœ°å­˜å‚¨ï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨', 'error');
                return false;
            }
        }
        
        // åˆå§‹æ£€æŸ¥
        checkLocalStorage();
    </script>
</body>
</html>
