<!DOCTYPE html>
<html>
<head>
    <title>æˆæœå±•ç­¾åˆ° - å‚ä¸æŠ½å¥–</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; text-align: center; padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 500px; margin: 0 auto; background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; backdrop-filter: blur(10px); }
        .qrcode { margin: 30px 0; background: white; padding: 15px; display: inline-block; border-radius: 10px; }
        input, button { padding: 12px; margin: 10px; width: 80%; border-radius: 8px; border: none; font-size: 16px; }
        button { background: #FFD700; color: #333; font-weight: bold; cursor: pointer; }
        #message { margin-top: 20px; font-weight: bold; }
        #qrcode { width: 200px; height: 200px; margin: 0 auto; }
    </style>
    <!-- ä½¿ç”¨ç¨³å®šå¯é çš„äºŒç»´ç åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ‰ æˆæœå±•æŠ½å¥–ç­¾åˆ° ğŸ‰</h1>
        <p>è¯·æ‰«ç ç­¾åˆ°ï¼Œå³å¯å‚ä¸æŠ½å¥–æ´»åŠ¨</p>
        <div class="qrcode">
            <!-- äºŒç»´ç å°†æ˜¾ç¤ºåœ¨è¿™ä¸ªcanvasä¸­ -->
            <canvas id="qrcodeCanvas"></canvas>
        </div>
        <p>æˆ–ç›´æ¥è¾“å…¥å§“åï¼š</p>
        <input type="text" id="name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
        <button onclick="signIn()">ç¡®è®¤ç­¾åˆ°</button>
        <div id="message"></div>
        <p style="font-size: 14px; margin-top: 30px;">ç­¾åˆ°æˆåŠŸå³è¿›å…¥æŠ½å¥–æ± ï¼Œæ¯äººä»…æœ‰ä¸€æ¬¡ä¸­å¥–æœºä¼š</p>
    </div>
    
    <script>
        // ç”Ÿæˆå½“å‰é¡µé¢äºŒç»´ç 
        function generateQRCode() {
            // è·å–å½“å‰é¡µé¢URL
            const pageUrl = window.location.href;
            
            // ä½¿ç”¨ QRCode.js ç”ŸæˆäºŒç»´ç 
            QRCode.toCanvas(
                document.getElementById('qrcodeCanvas'),
                pageUrl,
                {
                    width: 180,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                },
                function (error) {
                    if (error) {
                        console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
                        // å¦‚æœå¤±è´¥ï¼Œæ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
                        document.getElementById('qrcodeCanvas').parentElement.innerHTML = 
                            '<p style="color:red;">äºŒç»´ç ç”Ÿæˆå¤±è´¥<br>è¯·ç›´æ¥è®¿é—®æœ¬é¡µé¢</p>' +
                            '<p><small>ç½‘å€: ' + pageUrl + '</small></p>';
                    } else {
                        console.log('äºŒç»´ç ç”ŸæˆæˆåŠŸ!');
                    }
                }
            );
        }
        
        // é¡µé¢åŠ è½½æ—¶ç”ŸæˆäºŒç»´ç 
        window.onload = function() {
            generateQRCode();
            
            // æ£€æŸ¥QRCodeåº“æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof QRCode === 'undefined') {
                console.error('QRCodeåº“æœªåŠ è½½ï¼');
                // ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                useBackupQRCode();
            }
        };
        
        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨åœ¨çº¿APIç”ŸæˆäºŒç»´ç 
        function useBackupQRCode() {
            const pageUrl = window.location.href;
            const qrContainer = document.getElementById('qrcodeCanvas').parentElement;
            
            // ä½¿ç”¨åœ¨çº¿äºŒç»´ç ç”ŸæˆAPI
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(pageUrl)}`;
            
            qrContainer.innerHTML = `<img src="${qrUrl}" alt="ç­¾åˆ°äºŒç»´ç " style="width:180px;height:180px;">`;
        }
        
        // ç­¾åˆ°åŠŸèƒ½
        async function signIn() {
            const name = document.getElementById('name').value.trim();
            if (!name) { 
                alert('è¯·è¾“å…¥å§“å'); 
                return; 
            }
            
            // æ˜¾ç¤ºå¤„ç†ä¸­
            document.getElementById('message').innerHTML = 'å¤„ç†ä¸­...';
            document.getElementById('message').style.color = 'white';
            
            // 1. æœ¬åœ°å­˜å‚¨ç­¾åˆ°è®°å½•
            let signedUsers = JSON.parse(localStorage.getItem('signedUsers') || '[]');
            if (signedUsers.includes(name)) {
                document.getElementById('message').innerHTML = 'âš ï¸ æ‚¨å·²ç­¾åˆ°ï¼Œæ— éœ€é‡å¤æ“ä½œï¼';
                document.getElementById('message').style.color = '#FFD700';
                return;
            }
            
            // æ·»åŠ æ–°ç”¨æˆ·
            signedUsers.push(name);
            localStorage.setItem('signedUsers', JSON.stringify(signedUsers));
            
            // 2. åŒæ­¥åˆ°æŠ½å¥–æ± 
            let lotteryPool = JSON.parse(localStorage.getItem('lotteryPool') || '[]');
            if (!lotteryPool.find(u => u.name === name)) {
                lotteryPool.push({ 
                    name: name, 
                    id: Date.now(), 
                    isWon: false,
                    signTime: new Date().toLocaleString()
                });
                localStorage.setItem('lotteryPool', JSON.stringify(lotteryPool));
            }
            
            // 3. æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
            document.getElementById('message').innerHTML = `âœ… ${name}ï¼Œç­¾åˆ°æˆåŠŸï¼ç¥æ‚¨å¥½è¿ï¼`;
            document.getElementById('message').style.color = '#90EE90';
            document.getElementById('name').value = '';
            
            // 4. æ¨¡æ‹Ÿäº‘ç«¯åŒæ­¥
            console.log('ç­¾åˆ°æˆåŠŸ:', name);
            console.log('å½“å‰æŠ½å¥–æ± :', lotteryPool);
            
            // 5. å¯é€‰ï¼šæ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            try {
                const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
                audio.volume = 0.3;
                audio.play();
            } catch (e) {
                // å¿½ç•¥éŸ³æ•ˆé”™è¯¯
            }
        }
        
        // ç›‘å¬å›è½¦é”®
        document.getElementById('name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                signIn();
            }
        });
    </script>
</body>
</html>
